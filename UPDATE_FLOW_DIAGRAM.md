# Схема обновления Snapshot'а игрока - Визуализация

## Поток обновления

```
┌─────────────────────────────────────────────────────────────────┐
│  КЛИЕНТ отправляет POST /webhook/player-snapshot                │
│  {                                                               │
│    telegramId: 299235877,                                       │
│    player: {...},                                               │
│    market: {...},                                               │
│    events: [...],                                               │
│    lastSyncedAt: 1763473218056,                                 │
│    missions: [...],                                             │
│    achievements: [...],                                          │
│    availableProperties: [...]                                    │
│  }                                                               │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  N8N WEBHOOK NODE                                                │
│  Принимает запрос                                                │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  N8N CODE NODE                                                   │
│  Подготавливает SQL запрос:                                      │
│  - Извлекает данные из body                                      │
│  - Валидирует telegramId                                         │
│  - Формирует параметры для функции                              │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  N8N POSTGRES NODE                                               │
│  Выполняет:                                                      │
│  SELECT upsert_player_snapshot($1, $2, $3, ...)                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  PostgreSQL: upsert_player_snapshot()                             │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ШАГ 1: Обновление таблицы players                         │  │
│  │                                                            │  │
│  │  INSERT INTO players (...)                                │  │
│  │  ON CONFLICT (telegram_id) DO UPDATE SET                 │  │
│  │    cash = EXCLUDED.cash,                                  │  │
│  │    net_worth = EXCLUDED.net_worth,                       │  │
│  │    experience = EXCLUDED.experience,                      │  │
│  │    level = EXCLUDED.level,                               │  │
│  │    stats = EXCLUDED.stats,                                │  │
│  │    last_synced_at = EXCLUDED.last_synced_at               │  │
│  │                                                            │  │
│  │  Обновляет: cash, net_worth, stats, experience, level    │  │
│  │  НЕ обновляет: created_at (сохраняется)                  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ШАГ 2: Обновление таблицы player_snapshots                │  │
│  │                                                            │  │
│  │  INSERT INTO player_snapshots (...)                       │  │
│  │  ON CONFLICT (telegram_id) DO UPDATE SET                 │  │
│  │    player_data = EXCLUDED.player_data,                    │  │
│  │    market_data = EXCLUDED.market_data,                    │  │
│  │    events_data = EXCLUDED.events_data,                    │  │
│  │    missions_data = EXCLUDED.missions_data,               │  │
│  │    achievements_data = EXCLUDED.achievements_data,         │  │
│  │    available_properties_data = EXCLUDED.available_...,    │  │
│  │    last_synced_at = EXCLUDED.last_synced_at               │  │
│  │                                                            │  │
│  │  Полностью заменяет все JSONB объекты                     │  │
│  │  updated_at обновляется автоматически (триггер)           │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  ТРИГГЕР: update_updated_at_column()                            │
│  Автоматически обновляет updated_at = CURRENT_TIMESTAMP         │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  Возврат успешного ответа                                        │
│  {                                                               │
│    success: true,                                               │
│    telegramId: 299235877,                                       │
│    lastSyncedAt: 1763473218056,                                 │
│    message: "Snapshot saved successfully"                       │
│  }                                                               │
└─────────────────────────────────────────────────────────────────┘
```

## Структура данных

### Таблица `players` (основная информация)
```
┌─────────────────┬──────────────┬─────────────────────────────┐
│ Поле            │ Тип          │ Описание                     │
├─────────────────┼──────────────┼─────────────────────────────┤
│ telegram_id     │ BIGINT (PK)  │ ID из Telegram              │
│ player_id       │ VARCHAR      │ "player-299235877"           │
│ name            │ VARCHAR      │ "Игрок"                      │
│ cash            │ DECIMAL      │ 783365.00                    │
│ net_worth       │ DECIMAL      │ 1495183.33                   │
│ city_id         │ VARCHAR      │ "murmansk"                   │
│ difficulty      │ VARCHAR      │ "normal"                     │
│ experience      │ INTEGER      │ 458                           │
│ level           │ INTEGER      │ 1                             │
│ stats           │ JSONB        │ {"totalSales": 0, ...}       │
│ created_at      │ BIGINT       │ 1763470835049 (не обновляется)│
│ last_synced_at  │ BIGINT       │ 1763473218056                 │
│ updated_at      │ TIMESTAMP    │ 2024-01-20 10:30:18 (авто)   │
└─────────────────┴──────────────┴─────────────────────────────┘
```

### Таблица `player_snapshots` (полные данные)
```
┌──────────────────────────┬──────────────┬──────────────────────┐
│ Поле                     │ Тип          │ Описание             │
├──────────────────────────┼──────────────┼──────────────────────┤
│ telegram_id              │ BIGINT (PK)  │ ID из Telegram       │
│ player_data              │ JSONB        │ Полный объект Player │
│ market_data              │ JSONB        │ Полный MarketState   │
│ events_data              │ JSONB        │ Массив событий       │
│ missions_data            │ JSONB        │ Массив миссий        │
│ achievements_data        │ JSONB        │ Массив достижений    │
│ available_properties_data│ JSONB        │ Массив объектов      │
│ last_synced_at           │ BIGINT       │ Время синхронизации  │
│ updated_at               │ TIMESTAMP    │ Время обновления     │
└──────────────────────────┴──────────────┴──────────────────────┘
```

## Логика UPSERT

```
                    ┌─────────────────┐
                    │  Вызов функции  │
                    │ upsert_player_  │
                    │ snapshot(...)   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ Игрок существует│
                    │ в БД?           │
                    └────┬────────┬───┘
                         │        │
                    НЕТ  │        │  ДА
                         │        │
         ┌───────────────┘        └───────────────┐
         │                                         │
         ▼                                         ▼
┌─────────────────┐                      ┌─────────────────┐
│ INSERT (создать)│                      │ UPDATE (обновить)│
│                 │                      │                 │
│ - Создаёт новую │                      │ - Обновляет    │
│   запись        │                      │   существующую  │
│ - Устанавливает │                      │ - Заменяет все  │
│   created_at    │                      │   поля          │
│ - Устанавливает│                      │ - Сохраняет     │
│   все поля      │                      │   created_at    │
└─────────────────┘                      └─────────────────┘
         │                                         │
         └───────────────┬─────────────────────────┘
                         │
                         ▼
                ┌─────────────────┐
                │ Триггер обновляет│
                │ updated_at      │
                └─────────────────┘
```

## Частота обновлений

```
Время (секунды)
     │
  30 │  ●───●───●───●───●───●───●───●
     │  │   │   │   │   │   │   │   │
  25 │  │   │   │   │   │   │   │   │
     │  │   │   │   │   │   │   │   │
  20 │  │   │   │   │   │   │   │   │
     │  │   │   │   │   │   │   │   │
  15 │  │   │   │   │   │   │   │   │
     │  │   │   │   │   │   │   │   │
  10 │  │   │   │   │   │   │   │   │
     │  │   │   │   │   │   │   │   │
   5 │  │   │   │   │   │   │   │   │
     │  │   │   │   │   │   │   │   │
   0 └──┴───┴───┴───┴───┴───┴───┴───┴───►
     0   30  60  90 120 150 180 210 240

Каждые 30 секунд клиент отправляет snapshot
PostgreSQL обрабатывает через UPSERT (быстро)
```

## Производительность

### Индексы для быстрого поиска
```
┌─────────────────────────────────────────────────────────────┐
│ idx_players_telegram_id      → Поиск по telegram_id        │
│ idx_snapshots_telegram_id    → Поиск snapshot по telegram_id│
│ idx_snapshots_last_synced    → Поиск по времени синхронизации│
│ idx_snapshots_player_data    → GIN индекс для JSONB поиска │
│ idx_snapshots_market_data    → GIN индекс для JSONB поиска │
│ idx_snapshots_events_data    → GIN индекс для JSONB поиска │
└─────────────────────────────────────────────────────────────┘
```

### Оптимизация для частых обновлений
- ✅ UPSERT вместо SELECT + INSERT/UPDATE (1 запрос вместо 2)
- ✅ Индексы на часто используемых полях
- ✅ GIN индексы для быстрого поиска в JSONB
- ✅ Connection pooling в n8n
- ✅ Триггеры для автоматического обновления метаданных

