# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏–º–ø–æ—Ä—Ç—É –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ n8n Workflow

## üì• –ò–º–ø–æ—Ä—Ç Workflow

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ n8n

1. –í–æ–π–¥–∏—Ç–µ –≤ –≤–∞—à n8n instance
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **Workflows**

### –®–∞–≥ 2: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ JSON

1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **Import from File** –∏–ª–∏ **Import from URL**
2. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª `n8n-workflow-complete.json`
3. Workflow –±—É–¥–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —Å–æ –≤—Å–µ–º–∏ –Ω–æ–¥–∞–º–∏

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ PostgreSQL Credentials

**–í–ê–ñ–ù–û:** –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º workflow –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL!

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±—É—é PostgreSQL –Ω–æ–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Postgres: Save Snapshot")
2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ **Credentials** ‚Üí **Create New Credential**
3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:

```
Name: PostgreSQL Capital Game
Host: localhost (–∏–ª–∏ IP –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞)
Port: 5432
Database: capital_game
User: postgres (–∏–ª–∏ –≤–∞—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
Password: –≤–∞—à_–ø–∞—Ä–æ–ª—å
SSL: disable (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏) –∏–ª–∏ require (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
```

4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ credentials
5. –í—Å–µ PostgreSQL –Ω–æ–¥—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç—Ç–∏ credentials

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Workflow

### Workflow –≤–∫–ª—é—á–∞–µ—Ç 4 —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞:

#### 1. **POST /webhook/player-snapshot** - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ snapshot
- **Webhook ID**: `save-snapshot`
- **–ú–µ—Ç–æ–¥**: POST
- **–ü—É—Ç—å**: `player-snapshot`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç snapshot –∏–≥—Ä–æ–∫–∞ –≤ –ë–î

**–í—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "telegramId": 299235877,
  "player": {...},
  "market": {...},
  "events": [...],
  "lastSyncedAt": 1763473218056,
  "missions": [...],
  "achievements": [...],
  "availableProperties": [...]
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "telegramId": 299235877,
  "lastSyncedAt": 1763473218056,
  "message": "Snapshot saved successfully"
}
```

#### 2. **GET /webhook/player-snapshot** - –ü–æ–ª—É—á–µ–Ω–∏–µ snapshot
- **Webhook ID**: `get-snapshot`
- **–ú–µ—Ç–æ–¥**: GET
- **–ü—É—Ç—å**: `player-snapshot?telegramId=XXX`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –ü–æ–ª—É—á–∞–µ—Ç snapshot –∏–≥—Ä–æ–∫–∞ –∏–∑ –ë–î

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `telegramId` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) - ID –∏–≥—Ä–æ–∫–∞ –∏–∑ Telegram

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "player": {...},
  "market": {...},
  "events": [...],
  "missions": [...],
  "achievements": [...],
  "availableProperties": [...],
  "lastSyncedAt": 1763473218056
}
```

#### 3. **POST /webhook/auth** - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- **Webhook ID**: `auth`
- **–ú–µ—Ç–æ–¥**: POST
- **–ü—É—Ç—å**: `auth`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –ê–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –∏–≥—Ä–æ–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–≥–æ

**–í—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "telegramId": 299235877,
  "initData": "..." // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}
```

**–û—Ç–≤–µ—Ç (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–≥—Ä–æ–∫):**
```json
{
  "success": true,
  "playerId": "player-299235877",
  "isNewPlayer": false,
  "token": "token-299235877-1763473218056"
}
```

**–û—Ç–≤–µ—Ç (–Ω–æ–≤—ã–π –∏–≥—Ä–æ–∫):**
```json
{
  "success": true,
  "playerId": "player-299235877",
  "isNewPlayer": true,
  "token": "token-299235877-1763473218056"
}
```

#### 4. **GET /webhook/reference-data** - –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **Webhook ID**: `reference-data`
- **–ú–µ—Ç–æ–¥**: GET
- **–ü—É—Ç—å**: `reference-data`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã

**–û—Ç–≤–µ—Ç:**
```json
{
  "cities": [...],
  "loanPresets": {...},
  "marketPhases": [...],
  "startingCash": {...}
}
```

## üóÑÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º workflow:

1. **–°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:**
```sql
CREATE DATABASE capital_game;
```

2. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å—Ö–µ–º—É:**
```bash
psql -U postgres -d capital_game -f postgres-schema.sql
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ —Ñ–∞–π–ª–∞ `postgres-schema.sql`

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:**
```sql
\c capital_game
SELECT * FROM players LIMIT 1;
```

## üöÄ –ê–∫—Ç–∏–≤–∞—Ü–∏—è Workflow

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π workflow
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –Ω–æ–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **Active** –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
4. Workflow –Ω–∞—á–Ω—ë—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã

## üîó URL —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

–ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ workflow, —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –∞–¥—Ä–µ—Å–∞–º:

```
https://your-n8n-instance.com/webhook/player-snapshot  (POST)
https://your-n8n-instance.com/webhook/player-snapshot?telegramId=XXX  (GET)
https://your-n8n-instance.com/webhook/auth  (POST)
https://your-n8n-instance.com/webhook/reference-data  (GET)
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è snapshot:
```bash
curl -X POST https://your-n8n-instance.com/webhook/player-snapshot \
  -H "Content-Type: application/json" \
  -d '{
    "telegramId": 299235877,
    "player": {
      "id": "player-299235877",
      "telegramId": 299235877,
      "name": "–ò–≥—Ä–æ–∫",
      "cash": 783365,
      "netWorth": 1495183.33,
      "loans": [],
      "properties": [],
      "cityId": "murmansk",
      "difficulty": "normal",
      "experience": 458,
      "level": 1,
      "stats": {
        "totalSales": 0,
        "totalRentIncome": 33350,
        "totalRenovations": 0,
        "propertiesOwned": 1
      },
      "lastSyncedAt": 1763473218056,
      "createdAt": 1763470835049
    },
    "market": {
      "cityId": "murmansk",
      "phase": "—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å",
      "priceIndex": 1,
      "rentIndex": 1,
      "vacancyRate": 0.05,
      "activeEvents": [],
      "lastUpdatedAt": 1763473218056
    },
    "events": [],
    "lastSyncedAt": 1763473218056
  }'
```

### –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è snapshot:
```bash
curl "https://your-n8n-instance.com/webhook/player-snapshot?telegramId=299235877"
```

### –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
```bash
curl -X POST https://your-n8n-instance.com/webhook/auth \
  -H "Content-Type: application/json" \
  -d '{
    "telegramId": 299235877
  }'
```

### –¢–µ—Å—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
```bash
curl "https://your-n8n-instance.com/webhook/reference-data"
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è workflow:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **Executions**
2. –í—ã —É–≤–∏–¥–∏—Ç–µ –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
3. –ú–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –∫–∞–∂–¥–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å

### –õ–æ–≥–∏ PostgreSQL:

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –ë–î, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ PostgreSQL:
```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
tail -f /var/log/postgresql/postgresql-*.log

# Docker
docker logs postgres-capital
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Credentials**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PostgreSQL credentials –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –Ω–æ–¥
2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –°—Ö–µ–º–∞ –ë–î –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
3. **Webhook URLs**: –ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ workflow, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ URL —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
4. **CORS**: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞ –¥—Ä—É–≥–æ–º –¥–æ–º–µ–Ω–µ, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ CORS –≤ n8n
5. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSL –¥–ª—è PostgreSQL –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é initData

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è initData**: –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É Telegram initData –≤ –Ω–æ–¥—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
2. **Rate Limiting**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
3. **SSL**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
4. **–¢–æ–∫–µ–Ω—ã**: –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ JWT —Ç–æ–∫–µ–Ω—ã –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫
5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ "Credentials not found"
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏ PostgreSQL credentials
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ credentials –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –≤—Å–µ–º PostgreSQL –Ω–æ–¥–∞–º

### –û—à–∏–±–∫–∞ "relation does not exist"
- –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å—Ö–µ–º—É –∏–∑ `postgres-schema.sql`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –û—à–∏–±–∫–∞ "telegramId is required"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ

### Workflow –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –Ω–æ–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–¥–µ –Ω–æ–¥
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ n8n

## üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Workflow

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å workflow:

1. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ç–µ–∫—É—â–∏–π workflow (–¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏)
2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ credentials
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
5. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ workflow

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ workflow
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ PostgreSQL credentials
3. ‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å—Ö–µ–º—É
4. ‚úÖ –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ workflow
5. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
6. ‚úÖ –û–±–Ω–æ–≤–∏—Ç–µ URL –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
7. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

